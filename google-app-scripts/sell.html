<div class="container">
	<div class="row">
		<form id="product_form" class="col s12" onsubmit="sellProduct(this);">
			<div class="row">
				<div class="input-field col s12">
					<input id="product_name" name="product_name" type="text" class="validate" required>
					<label for="product_name">Product name*</label>
				</div>
			</div>
			<div class="row">
				<div class="input-field col s12">
					<input id="product_unit_price" name="product_unit_price" type="number" class="validate" required>
					<label for="product_unit_price">Unit price*</label>
				</div>
			</div>
			<div class="row">
				<div class="input-field col s6">
					<input id="product_quantity" name="product_quantity" type="number" class="validate" min=1 required>
					<label for="product_quantity">Quantity*</label>
				</div>
				<div class="input-field col s6">
					<input disabled value="10" id="available_quantity" type="text" class="validate">
					<label for="available_quantity">Available</label>
				</div>
			</div>

			<button id="btn" class="waves-effect waves-light btn-small darken-3">
          <i class="material-icons left">chevron_right</i>
          Sell product
        </button>
		</form>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
     google.script.run.withSuccessHandler(onLoadProducts).getAvailableProducts();
  });
	
  function onLoadProducts(products) {
    var elem = document.querySelector('#product_name');
    elem.setAttribute('data-products', JSON.stringify(products));
    var instances = M.Autocomplete.init(elem, {
      data: products.reduce((acc, e) => {
          acc[e.name] = null;
          return acc;
        }, {}),
      onAutocomplete: (d) => onProductSelect(d, JSON.parse(elem.getAttribute('data-products')))
      }
    )
  }

  function onProductSelect(selected, products = []) {
    const selectedProduct = products.find(p => p.name === selected) || {};
    document.getElementById('product_unit_price').value = selectedProduct.price;
    document.getElementById('available_quantity').value = selectedProduct.quantity;
    document.getElementById('product_quantity').setAttribute('max', selectedProduct.quantity);
    M.updateTextFields();
  }

  function sellProduct(formObject) {
      //google.script.run.withSuccessHandler(resetForm).submitProduct(formObject);
    }

    function resetForm() {
      M.toast({html: 'Product was sold successfully.', classes: 'rounded'});
      document.getElementById("product_form").reset();
    }
</script>